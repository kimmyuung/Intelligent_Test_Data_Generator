plugins {
    id 'java'
    id 'org.springframework.boot' version '4.0.0' apply false
    id 'io.spring.dependency-management' version '1.1.7'
}

// ë²„ì „ ê´€ë¦¬
ext {
    springCloudVersion = '2025.1.0'
    lombokVersion = '1.18.32'
}

// ëª¨ë“  í”„ë¡œì íŠ¸ ê³µí†µ ì„¤ì • (group, version, repository ë“± ê¸°ë³¸ ì„¤ì •)
allprojects {
    group = 'com.itdg'
    version = '1.0.0-SNAPSHOT'

    repositories {
        mavenCentral()
    }
}

// =======================================================
// ğŸ’¡ ì„œë¸Œ í”„ë¡œì íŠ¸ ê³µí†µ ì„¤ì • (í”ŒëŸ¬ê·¸ì¸, Java ë²„ì „, BOM ê´€ë¦¬)
// ëª¨ë“  ì„œë¸Œ í”„ë¡œì íŠ¸ì— ì ìš©ë˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.
// =======================================================
subprojects {
    // 1. ê³µí†µ í”ŒëŸ¬ê·¸ì¸ ì ìš© (dependencies ë¸”ë¡ ì´ì „ì—)
    apply plugin: 'java'
    apply plugin: 'io.spring.dependency-management'

    // Java 21 ì„¤ì •
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }

    // ì»´íŒŒì¼ ì˜µì…˜
    tasks.withType(JavaCompile) {
        options.encoding = 'UTF-8'
        options.compilerArgs += ['-parameters']
    }

    // í…ŒìŠ¤íŠ¸ ì„¤ì •
    tasks.named('test') {
        useJUnitPlatform()
        testLogging {
            events "passed", "skipped", "failed"
            exceptionFormat "full"
        }

        // ğŸ’¡ 1. JVM ë©”ëª¨ë¦¬ ì„¤ì • (ìì› ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ ë¹„ì •ìƒ ì¢…ë£Œ ë°©ì§€)
        maxHeapSize = "1024m" // 1GB í• ë‹¹
        jvmArgs = ['-Dfile.encoding=UTF-8']

        // ğŸ’¡ 2. ë³‘ë ¬ ì‹¤í–‰ ë¹„í™œì„±í™” (I/O ë° í”„ë¡œì„¸ìŠ¤ ê°„ ì¶©ëŒ ë°©ì§€)
        maxParallelForks = 1
    }

    // ì˜ì¡´ì„± ê´€ë¦¬ (BOM, ì˜ì¡´ì„± ë²„ì „ ëª…ì‹œ)
    dependencyManagement {
        imports {
            // Spring Boot BOM (ë²„ì „ì€ root plugins ë¸”ë¡ê³¼ ì¼ì¹˜)
            mavenBom "org.springframework.boot:spring-boot-dependencies:4.0.0"
            // Spring Cloud BOM
            mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
        }
        dependencies {
            dependency "org.projectlombok:lombok:${lombokVersion}"
        }
    }

    // ê³µí†µ ì˜ì¡´ì„± (ì—¬ê¸°ì— ë‘ì–´ë„ 'java' í”ŒëŸ¬ê·¸ì¸ì´ ì ìš©ë˜ì—ˆìœ¼ë¯€ë¡œ ë¬¸ì œ ì—†ìŒ)
    dependencies {
        // Lombok
        compileOnly 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'

        // í…ŒìŠ¤íŠ¸ ê³µí†µ ì˜ì¡´ì„±
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
        testCompileOnly 'org.projectlombok:lombok'
        testAnnotationProcessor 'org.projectlombok:lombok'
    }
}
// =======================================================


// ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª¨ë“ˆ ì„¤ì • (ì‹¤í–‰ ë¶ˆê°€, java-library í”ŒëŸ¬ê·¸ì¸ ì ìš©)
configure(subprojects.findAll { it.name in ['itdg-domain', 'itdg-common'] }) {
    apply plugin: 'java-library' // java í”ŒëŸ¬ê·¸ì¸ì„ java-libraryë¡œ ë®ì–´ì”ë‹ˆë‹¤.

    jar {
        enabled = true
    }
}


// ì• í”Œë¦¬ì¼€ì´ì…˜ ëª¨ë“ˆ ì„¤ì • (ì‹¤í–‰ ê°€ëŠ¥, Spring Boot í”ŒëŸ¬ê·¸ì¸ ì ìš©)
configure(subprojects.findAll { it.name in ['itdg-orchestrator', 'itdg-analyzer', 'itdg-generator'] }) {
    apply plugin: 'org.springframework.boot' // org.springframework.boot í”ŒëŸ¬ê·¸ì¸ ì ìš©

    bootJar {
        enabled = true
    }

    jar {
        enabled = false
    }
}